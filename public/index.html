paypal.Buttons({
  createOrder: async () => {
    const r = await fetch('/.netlify/functions/create-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cart: [{ id: 'beat_001' }] })
    });
    const text = await r.text();
    let data;
    try { data = JSON.parse(text); } catch (e) { throw new Error(text); }
    if (!r.ok) throw new Error(data?.error || text);
    if (!data?.orderId) throw new Error('orderId missing');
    return data.orderId;
  },
  onApprove: async (data) => {
    const email = localStorage.getItem('buyer_email') || document.getElementById('email').value.trim();
    const r = await fetch('/.netlify/functions/capture-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ orderId: data.orderID, notifyEmail: email || undefined })
    });
    const t = await r.text();
    try {
      const j = JSON.parse(t);
      alert(j.status === 'COMPLETED'
        ? 'Danke! Wenn du eine E-Mail eingetragen hast, sind die Downloadlinks unterwegs.'
        : 'Zahlungsstatus: ' + j.status);
    } catch(e) { alert('Antwort: ' + t); }
  },
  onError: (err) => {
    alert('Fehler beim Starten der Zahlung: ' + (err?.message || err));
  }
}).render('#paypal');
